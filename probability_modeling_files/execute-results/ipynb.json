{
  "hash": "961d58f9c0829ad8134d18e3b655ecbc",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Modeling the Probability of a Ground Ball Being a Successful Play\"\nformat: html\n---\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nlibrary(tidyverse)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──\n✔ dplyr     1.1.4     ✔ readr     2.1.5\n✔ forcats   1.0.0     ✔ stringr   1.5.2\n✔ ggplot2   4.0.0     ✔ tibble    3.3.0\n✔ lubridate 1.9.4     ✔ tidyr     1.3.1\n✔ purrr     1.1.0     \n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter() masks stats::filter()\n✖ dplyr::lag()    masks stats::lag()\nℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\nlibrary(lme4)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nLoading required package: Matrix\n\nAttaching package: 'Matrix'\n\nThe following objects are masked from 'package:tidyr':\n\n    expand, pack, unpack\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\nlibrary(broom.mixed)\nlibrary(brms)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nLoading required package: Rcpp\nLoading 'brms' package (version 2.22.0). Useful instructions\ncan be found by typing help('brms'). A more detailed introduction\nto the package is available through vignette('brms_overview').\n\nAttaching package: 'brms'\n\nThe following object is masked from 'package:lme4':\n\n    ngrps\n\nThe following object is masked from 'package:stats':\n\n    ar\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\nbip_gb <- readRDS(\"statcast_data/bip_gb.rds\")\n\nsafe_positioning <- readRDS(\"statcast_data/player_positioning/safe_positioning.rds\")\n```\n:::\n\n\n## Example: Successful Play Probability Model for SS in 2025\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n# Fitting a model for shortstops (SS) in 2025\n\npos_ss <- safe_positioning |>\n  filter(play_made_by == \"SS\")\n\nbip_gb_ss_2025 <- bip_gb |>\n  filter(\n    game_year == 2025,\n    (successful_play == 1 & play_made_by == \"SS\") | (successful_play == 0)\n  ) |>\n  mutate(\n    pos_x = pos_ss$pos_x,\n    pos_y = pos_ss$pos_y,\n    pos_angle = pos_ss$pos_angle,\n    theta = abs(pos_angle - spray_angle),\n    move_left = ifelse(spray_angle < pos_angle, 1, 0),\n    fielder_id = as.factor(fielder_6)\n  ) |>\n  # filter out NA for all variables used in the model\n  filter(\n    !is.na(launch_speed),\n    !is.na(theta),\n    theta <= 45\n  ) |>\n  # scaling continuous variables\n  mutate(\n    launch_speed_scaled = scale(launch_speed)[,1],\n    theta_scaled = scale(theta)[,1]\n  )\n\nplayers_num_plays <- bip_gb_ss_2025 |>\n  group_by(fielder_id) |>\n  summarise(num_plays = n()) |>\n  arrange(num_plays) |>\n  filter(num_plays >= 10) |>\n  pluck(\"fielder_id\")\n\nbip_gb_ss_2025 <- bip_gb_ss_2025 |>\n  filter(fielder_id %in% players_num_plays)\n```\n:::\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n# probability of a successful play by theta\n\nbip_gb_ss_2025 |>\n  ggplot(aes(x = launch_speed, color = as.factor(successful_play))) +\n  geom_density() +\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](probability_modeling_files/figure-ipynb/unnamed-chunk-3-1.png)\n:::\n:::\n\n\n### Probit Regression (without random effects)\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n# Probit regression model without random effects\nmodel_ss_2025_re_none <- glm(\n  out_ss ~ theta_scaled + theta_scaled:move_left + \n    theta_scaled:launch_speed_scaled + theta_scaled:launch_speed_scaled:move_left,\n  data = bip_gb_ss_2025,\n  family = binomial(link = \"probit\")\n)\n```\n:::\n\n\n\n### Probit Regression (with full random effects)\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n# Probit regression model with full random effects\nmodel_ss_2025_re_full <- glmer(\n  out_ss ~ theta_scaled + theta_scaled:move_left + \n    theta_scaled:launch_speed_scaled + theta_scaled:launch_speed_scaled:move_left +\n    (1 + theta_scaled || fielder_id),\n  data = bip_gb_ss_2025,\n  family = binomial(link = \"probit\"),\n  control = glmerControl(optimizer = \"bobyqa\", optCtrl = list(maxfun = 2e5))\n)\n\nsummary(model_ss_2025_re_full)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nGeneralized linear mixed model fit by maximum likelihood (Laplace\n  Approximation) [glmerMod]\n Family: binomial  ( probit )\nFormula: \nout_ss ~ theta_scaled + theta_scaled:move_left + theta_scaled:launch_speed_scaled +  \n    theta_scaled:launch_speed_scaled:move_left + (1 + theta_scaled ||  \n    fielder_id)\n   Data: bip_gb_ss_2025\nControl: glmerControl(optimizer = \"bobyqa\", optCtrl = list(maxfun = 2e+05))\n\n     AIC      BIC   logLik deviance df.resid \n 20232.2  20287.8 -10109.1  20218.2    20537 \n\nScaled residuals: \n    Min      1Q  Median      3Q     Max \n-4.6807 -0.6260 -0.0338  0.6311 10.0512 \n\nRandom effects:\n Groups       Name         Variance Std.Dev.\n fielder_id   (Intercept)  0.002146 0.04633 \n fielder_id.1 theta_scaled 0.007719 0.08786 \nNumber of obs: 20544, groups:  fielder_id, 97\n\nFixed effects:\n                                           Estimate Std. Error z value Pr(>|z|)\n(Intercept)                                -0.17751    0.01307 -13.584  < 2e-16\ntheta_scaled                               -0.87114    0.02218 -39.276  < 2e-16\ntheta_scaled:move_left                     -0.53348    0.03003 -17.762  < 2e-16\ntheta_scaled:launch_speed_scaled           -0.02546    0.01789  -1.423 0.154616\ntheta_scaled:move_left:launch_speed_scaled  0.10298    0.02882   3.573 0.000353\n                                              \n(Intercept)                                ***\ntheta_scaled                               ***\ntheta_scaled:move_left                     ***\ntheta_scaled:launch_speed_scaled              \ntheta_scaled:move_left:launch_speed_scaled ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nCorrelation of Fixed Effects:\n            (Intr) tht_sc tht_:_ th_:__\ntheta_scald  0.100                     \ntht_scld:m_  0.222 -0.462              \ntht_scld:__ -0.032 -0.001 -0.010       \ntht_sc:_:__  0.038  0.000  0.040 -0.621\n```\n\n\n:::\n:::\n\n\n\n### Case Study: Jeremy Pena (2nd best) vs. Bo Bichette (2nd worst)\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n# Creating a synthetic dataset with all plausible theta values for a fixed launch speed\nlaunch_speed <- 90\ntheta_values <- seq(-35, 35, by = 0.1)\nplayer_ids <- c(665161, 666182)  # Jeremy Pena and Bo Bichette\n\nsynthetic_data <- expand.grid(\n  theta = theta_values,\n  fielder_id = player_ids\n  ) |>\n  mutate(\n    launch_speed = launch_speed,\n    move_left = ifelse(theta < 0, 1, 0),\n    theta_abs = abs(theta),\n    theta_scaled = (theta_abs - mean(bip_gb_ss_2025$theta)) / sd(bip_gb_ss_2025$theta),\n    launch_speed_scaled = (launch_speed - mean(bip_gb_ss_2025$launch_speed)) / sd(bip_gb_ss_2025$launch_speed)\n  )\n\nsynthetic_data <- synthetic_data |>\n  mutate(\n    prob_play_avg = predict(model_ss_2025_re_none, newdata = synthetic_data, type = \"response\")\n  )\n\n# Predicting probabilities for the synthetic dataset\npredictions <- synthetic_data |>\n  mutate(\n    prob_play_player = predict(model_ss_2025_re_full, newdata = synthetic_data, type = \"response\")\n  )\n\n# three curves, one for the average, and one for each player\nggplot(predictions, aes(x = theta, y = prob_play_player, color = as.factor(fielder_id))) +\n  geom_smooth() +\n  geom_smooth(aes(y = prob_play_avg), color = \"black\", linetype = \"dashed\", size = 1) +\n  labs(\n    title = \"Predicted Probability of Successful Play vs. Theta\",\n    x = \"Theta (degrees)\",\n    y = \"Predicted Probability of Successful Play\",\n    color = \"Fielder ID\"\n  ) +\n  scale_color_manual(\n    values = c(\"665161\" = \"blue\", \"666182\" = \"red\"),\n    labels = c(\"665161\" = \"Jeremy Pena\", \"666182\" = \"Bo Bichette\")\n  ) +\n  theme_minimal()\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nWarning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.\nℹ Please use `linewidth` instead.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n`geom_smooth()` using method = 'loess' and formula = 'y ~ x'\n`geom_smooth()` using method = 'gam' and formula = 'y ~ s(x, bs = \"cs\")'\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](probability_modeling_files/figure-ipynb/unnamed-chunk-6-1.png)\n:::\n:::\n\n\n### Visualizing Random Intercepts\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n# get random effects with standard errors for each fielder\nre_fielder <- ranef(model_ss_2025_re_full, condVar = TRUE)$fielder_id\n\nse_fielder <- sqrt(sapply(attr(re_fielder, \"postVar\"), function(x) x[1, 1, ]))\n\nfielder_effects <- data.frame(\n  fielder_id = rownames(re_fielder),\n  random_intercept = re_fielder[, 1],\n  random_theta = re_fielder[, 2],\n  se = se_fielder\n)\n```\n:::\n\n\n\n::: {#cell-fig-random-intercepts .cell}\n\n```{.r .cell-code .hidden}\n#| label: fig-random-intercepts\n#| fig-cap: \"Random Intercepts for SS Fielders in 2025 with 95% Confidence Intervals\"\n#| fig-width: 8\n#| fig-height: 6\n\nggplot(fielder_effects, aes(x = reorder(fielder_id, random_intercept), y = random_intercept)) +\n  geom_point() +\n  geom_errorbar(aes(ymin = random_intercept - 1.96 * `se..Intercept.`, ymax = random_intercept + 1.96 * `se..Intercept.`), width = 0.2) +\n  coord_flip() +\n  geom_hline(yintercept = 0, linetype = \"dashed\", color = \"red\") +\n  labs(\n    title = \"Random Intercepts for SS Fielders with 95% CI\",\n    x = \"Fielder ID\",\n    y = \"Random Intercept (u_i)\"\n  ) +\n  theme_classic() +\n  theme(\n    axis.text.y = element_blank()\n  )\n```\n\n::: {.cell-output-display}\n![Random Intercepts for SS Fielders in 2025 with 95% Confidence Intervals](probability_modeling_files/figure-ipynb/fig-random-intercepts-1.png){#fig-random-intercepts}\n:::\n:::\n\n\n\n::: {#cell-fig-random-slopes .cell}\n\n```{.r .cell-code .hidden}\n#| label: fig-random-slopes\n#| fig-cap: \"Random Slopes for Theta SS Fielders in 2025 with 95% Confidence Intervals\"\n#| fig-width: 8\n#| fig-height: 6\n\nggplot(fielder_effects, aes(x = reorder(fielder_id, random_theta), y = random_theta)) +\n  geom_point() +\n  geom_errorbar(aes(ymin = random_theta - 1.96 * `se.theta_scaled`, ymax = random_theta + 1.96 * `se.theta_scaled`), width = 0.2) +\n  coord_flip() +\n  geom_hline(yintercept = 0, linetype = \"dashed\", color = \"red\") +\n  labs(\n    title = \"Random Slopes for Theta SS Fielders with 95% CI\",\n    x = \"Fielder ID\",\n    y = \"Random Slope (u_theta)\"\n  ) +\n  theme_classic() +\n  theme(\n    axis.text.y = element_blank()\n  )\n```\n\n::: {.cell-output-display}\n![Random Slopes for Theta SS Fielders in 2025 with 95% Confidence Intervals](probability_modeling_files/figure-ipynb/fig-random-slopes-1.png){#fig-random-slopes}\n:::\n:::\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n#| eval: FALSE\n\n# Function to calculate \nfit_SAFE <- function(bip_data, year, position, positioning_data, batted_balls) {\n  \n  # Filter positioning data for the relevant year and position\n  pos <- positioning_data |>\n    filter(play_made_by == !!position)\n  \n  # Merge position coordinates onto play data, filter to year, and compute features\n  play_data <- bip_data |>\n    filter(\n      game_year == year,\n      (successful_play == 1 & play_made_by == position) | (successful_play == 0)\n    ) |>\n    mutate(\n      pos_x = pos$pos_x,\n      pos_y = pos$pos_y,\n      pos_angle = pos$pos_angle,\n      theta = abs(pos_angle - spray_angle),\n      move_left = ifelse(spray_angle < pos_angle, 1, 0),\n      fielder_id = case_when(\n        position == \"1B\" ~ fielder_3,\n        position == \"2B\" ~ fielder_4,\n        position == \"3B\" ~ fielder_5,\n        position == \"SS\" ~ fielder_6,\n        TRUE ~ NA\n      )\n    ) |>\n    # scaling continuous variables\n    mutate(\n      launch_speed = scale(launch_speed)[,1],\n      theta = scale(theta)[,1]\n    ) |>\n    # filter out NA for all variables used in the model\n    filter(\n      !is.na(fielder_id),\n      !is.na(launch_speed),\n      !is.na(theta)\n    )\n  \n  # Create the outcome variable name dynamically\n  outcome_var <- paste0(\"out_\", str_to_lower(position))\n  \n  # -------------------------- RUN EXPECTANCY MODEL ----------------------------\n  \n  mod_run_value <- gam(delta_run_exp ~ s(launch_speed) +\n                                       s(spray_angle) + \n                                       launch_speed:spray_angle,\n                       data = bip_gb)\n  \n  # ------------------------- POPULATION LEVEL MODEL ---------------------------\n  formula_str_avg <- paste0(\n    outcome_var, \" ~ 1 + theta + theta:move_left + \",\n    \"theta:launch_speed + theta:launch_speed:move_left + \"\n  )\n  \n  mod_avg <- glmer(\n    formula = as.formula(formula_str_avg),\n    data = play_data,\n    family = binomial(link = \"probit\"),\n    control = glmerControl(optimizer = \"bobyqa\", optCtrl = list(maxfun = 2e5))\n  )\n  \n  # ------------------------ FULL RANDOM EFFECTS MODEL -------------------------\n  formula_str_player <- paste0(\n    outcome_var, \" ~ 1 + theta + theta:move_left + \",\n    \"theta:launch_speed + theta:launch_speed:move_left + \",\n    \"(1 + theta | fielder_id)\"\n  )\n  \n  mod_player <- glmer(\n    formula = as.formula(formula_str_player),\n    data = play_data,\n    family = binomial(link = \"probit\"),\n    control = glmerControl(optimizer = \"bobyqa\", optCtrl = list(maxfun = 2e5))\n  )\n  \n  \n  # ---------------------- CALCULATING SAFE METRICS ----------------------------\n  \n  batted_balls <- batted_balls |>\n    mutate(\n      pos_angle = pos$pos_angle,\n      theta = abs(pos_angle - spray_angle),\n      move_left = ifelse(spray_angle < pos_angle, 1, 0),\n      # standardize variables based on training data\n      launch_speed = (launch_speed - mean(play_data$launch_speed)) / sd(play_data$launch_speed),\n      theta = (theta - mean(play_data$theta)) / sd(play_data$theta),\n      run_value = predict(mod_run_value, newdata = batted_balls),\n      prob_play_avg = predict(mod_avg, newdata = batted_balls, type = \"response\")\n    )\n  \n  fielders <- unique(bip_data$fielder_id)\n  \n  # Set up a data frame to store SAFE results\n  safe_results <- data.frame()\n  \n  for (fielder in fielders) {\n    \n    batted_balls |>\n      mutate(\n        fielder_id = fielder,\n        prob_play_player = predict(mod_player, newdata = batted_balls, type = \"response\"),\n        prob_play_added = prob_play_player - prob_play_avg,\n        SAFE = prob_play_added * run_value\n      ) |>\n      summarize(\n        SAFE = sum(SAFE, na.rm = TRUE),\n        num_plays = n()\n      )\n    \n    # append fielderid, position, SAFE, and num_plays to safe_results\n    safe_results <- rbind(safe_results,\n                          data.frame(\n                            fielder_id = fielder,\n                            position = position,\n                            SAFE = sum(SAFE, na.rm = TRUE),\n                            num_plays = n()\n                          ))\n    \n  }\n  \n  \n  \n}\n```\n:::\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n#| eval: FALSE\nyears <- c(2023, 2024, 2025)\npositions <- c(\"1B\", \"2B\", \"3B\", \"SS\")\n\n\n\n\n# -------------------------- SAFE POSITIONING DATA -----------------------------\n\nfor (year in years) {\n  for (position in positions) {\n    bip_gb_year <- bip_gb |>\n      filter(game_year == year)\n    \n    safe_positioning_year <- safe_positioning |>\n      filter(game_year == year, play_made_by == position)\n    \n    safe_results <- fit_SAFE(\n      bip_data = bip_gb,\n      year = year,\n      position = position,\n      positioning_data = safe_positioning_year,\n      batted_balls = bip_gb\n    )\n    \n    # Save the SAFE results\n    saveRDS(\n      safe_results,\n      file = paste0(\"statcast_data/safe_positioning/safe_\", position, \"_\", year, \".rds\")\n    )\n  }\n}\n\n# ------------------------- STATCAST POSITIONING DATA --------------------------\n\nsc_positioning <- readRDS(\"statcast_data/player_positioning/sc_positioning.rds\")\n```\n:::\n\n\n",
    "supporting": [
      "probability_modeling_files/figure-ipynb"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": null,
    "postProcess": false
  }
}