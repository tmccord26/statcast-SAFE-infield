---
title: "Modeling the Probability of a Ground Ball Being a Successful Play"
format: html
---

```{r}
library(tidyverse)
library(lme4)
library(broom.mixed)
library(mgcv)
library(ks)

bip_gb <- readRDS("statcast_data/bip_gb.rds")

safe_positioning <- readRDS("statcast_data/player_positioning/safe_positioning.rds")
```

## Example: Successful Play Probability Model for SS in 2025

```{r}
# Fitting a model for shortstops (SS) in 2025

pos_ss <- safe_positioning |>
  filter(play_made_by == "SS")

bip_gb_ss_2025 <- bip_gb |>
  filter(
    game_year == 2025,
    (successful_play == 1 & play_made_by == "SS") | (successful_play == 0)
  ) |>
  mutate(
    pos_x = pos_ss$pos_x,
    pos_y = pos_ss$pos_y,
    pos_angle = pos_ss$pos_angle,
    theta = abs(pos_angle - spray_angle),
    move_left = ifelse(spray_angle < pos_angle, 1, 0),
    fielder_id = as.factor(fielder_6)
  ) |>
  # filter out NA for all variables used in the model
  filter(
    !is.na(launch_speed),
    !is.na(theta),
    theta <= 45
  ) |>
  # scaling continuous variables
  mutate(
    launch_speed_scaled = scale(launch_speed)[,1],
    theta_scaled = scale(theta)[,1]
  )

players_num_plays <- bip_gb_ss_2025 |>
  group_by(fielder_id) |>
  summarise(num_plays = n()) |>
  arrange(num_plays) |>
  filter(num_plays >= 10) |>
  pluck("fielder_id")

bip_gb_ss_2025 <- bip_gb_ss_2025 |>
  filter(fielder_id %in% players_num_plays)
```


```{r}
# probability of a successful play by theta

bip_gb_ss_2025 |>
  ggplot(aes(x = launch_speed, color = as.factor(successful_play))) +
  geom_density() +
  theme_minimal()
```

## Data Wrangling

```{r}
bip_gb <- bip_gb |>
  filter(!is.na(launch_speed))
```


### Probit Regression (without random effects)

```{r}
# Probit regression model without random effects
model_ss_2025_re_none <- glm(
  out_ss ~ theta_scaled + theta_scaled:move_left + 
    theta_scaled:launch_speed_scaled + theta_scaled:launch_speed_scaled:move_left,
  data = bip_gb_ss_2025,
  family = binomial(link = "probit")
)
```


### Probit Regression (with full random effects)

```{r}
# Probit regression model with full random effects
model_ss_2025_re_full <- glmer(
  out_ss ~ theta_scaled + theta_scaled:move_left + 
    theta_scaled:launch_speed_scaled + theta_scaled:launch_speed_scaled:move_left +
    (1 + theta_scaled || fielder_id),
  data = bip_gb_ss_2025,
  family = binomial(link = "probit"),
  control = glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 2e5))
)

summary(model_ss_2025_re_full)
```


### Case Study: Jeremy Pena (2nd best) vs. Bo Bichette (2nd worst)

```{r}

# Creating a synthetic dataset with all plausible theta values for a fixed launch speed
launch_speed <- 90
theta_values <- seq(-35, 35, by = 0.1)
player_ids <- c(665161, 666182)  # Jeremy Pena and Bo Bichette

synthetic_data <- expand.grid(
  theta = theta_values,
  fielder_id = player_ids
  ) |>
  mutate(
    launch_speed = launch_speed,
    move_left = ifelse(theta < 0, 1, 0),
    theta_abs = abs(theta),
    theta_scaled = (theta_abs - mean(bip_gb_ss_2025$theta)) / sd(bip_gb_ss_2025$theta),
    launch_speed_scaled = (launch_speed - mean(bip_gb_ss_2025$launch_speed)) / sd(bip_gb_ss_2025$launch_speed)
  )

synthetic_data <- synthetic_data |>
  mutate(
    prob_play_avg = predict(model_ss_2025_re_none, newdata = synthetic_data, type = "response")
  )

# Predicting probabilities for the synthetic dataset
predictions <- synthetic_data |>
  mutate(
    prob_play_player = predict(model_ss_2025_re_full, newdata = synthetic_data, type = "response")
  )

# three curves, one for the average, and one for each player
ggplot(predictions, aes(x = theta, y = prob_play_player, color = as.factor(fielder_id))) +
  geom_smooth() +
  geom_smooth(aes(y = prob_play_avg), color = "black", linetype = "dashed", size = 1) +
  labs(
    title = "Predicted Probability of Successful Play vs. Theta",
    x = "Theta (degrees)",
    y = "Predicted Probability of Successful Play",
    color = "Fielder ID"
  ) +
  scale_color_manual(
    values = c("665161" = "blue", "666182" = "red"),
    labels = c("665161" = "Jeremy Pena", "666182" = "Bo Bichette")
  ) +
  theme_minimal()
```

### Visualizing Random Intercepts

```{r}

# get random effects with standard errors for each fielder
re_fielder <- ranef(model_ss_2025_re_full, condVar = TRUE)$fielder_id

se_fielder <- sqrt(sapply(attr(re_fielder, "postVar"), function(x) x[1, 1, ]))

fielder_effects <- data.frame(
  fielder_id = rownames(re_fielder),
  random_intercept = re_fielder[, 1],
  random_theta = re_fielder[, 2],
  se = se_fielder
)

```

```{r}
#| label: fig-random-intercepts
#| fig-cap: "Random Intercepts for SS Fielders in 2025 with 95% Confidence Intervals"
#| fig-width: 8
#| fig-height: 6

ggplot(fielder_effects, aes(x = reorder(fielder_id, random_intercept), y = random_intercept)) +
  geom_point() +
  geom_errorbar(aes(ymin = random_intercept - 1.96 * `se..Intercept.`, ymax = random_intercept + 1.96 * `se..Intercept.`), width = 0.2) +
  coord_flip() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  labs(
    title = "Random Intercepts for SS Fielders with 95% CI",
    x = "Fielder ID",
    y = "Random Intercept (u_i)"
  ) +
  theme_classic() +
  theme(
    axis.text.y = element_blank()
  )
```

```{r}
#| label: fig-random-slopes
#| fig-cap: "Random Slopes for Theta SS Fielders in 2025 with 95% Confidence Intervals"
#| fig-width: 8
#| fig-height: 6

ggplot(fielder_effects, aes(x = reorder(fielder_id, random_theta), y = random_theta)) +
  geom_point() +
  geom_errorbar(aes(ymin = random_theta - 1.96 * `se.theta_scaled`, ymax = random_theta + 1.96 * `se.theta_scaled`), width = 0.2) +
  coord_flip() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  labs(
    title = "Random Slopes for Theta SS Fielders with 95% CI",
    x = "Fielder ID",
    y = "Random Slope (u_theta)"
  ) +
  theme_classic() +
  theme(
    axis.text.y = element_blank()
  )
```



### 2D Kernel Density of Ground Balls by Spray Angle and Launch Speed

```{r}
# Fitting 2D kernel density equations for spray angle and launch speed

bip_gb <- bip_gb |> filter(
  !is.na(spray_angle),
  !is.na(launch_speed)
)

XY <- cbind(bip_gb$spray_angle, bip_gb$launch_speed)
kde_fit <- kde(x = XY)

# Search grid
launch_speeds <- seq(50, 110, 1)
spray_angles  <- seq(-45, 45, 1)

batted_balls <- expand.grid(
  spray_angle = spray_angles,
  launch_speed = launch_speeds
)

# Evaluate KDE directly at each grid point
batted_balls$density <- predict(
  kde_fit,
  x = cbind(batted_balls$spray_angle,
            batted_balls$launch_speed)
)

# plot the densities
ggplot(batted_balls, aes(x = spray_angle, y = launch_speed, fill = density)) +
  geom_tile() +
  scale_fill_viridis_c() +
  labs(
    title = "2D Kernel Density Estimate of Ground Balls by Spray Angle and Launch Speed",
    x = "Spray Angle (degrees)",
    y = "Launch Speed (mph)",
    fill = "Density"
  ) +
  theme_minimal()

```


### Fitting a Run Value Model

```{r}
# Fitting a run expectancy model
mod_run_value <- gam(delta_run_exp ~ s(launch_speed) +
                                     s(spray_angle) + 
                                     launch_speed:spray_angle,
                     data = bip_gb)

batted_balls$run_value <- predict(mod_run_value, newdata = batted_balls)
```

## Testing on SS in 2025

```{r}
# Merge position coordinates onto play data, filter to year, and compute features
  
  # ------------------------ FULL RANDOM EFFECTS MODEL -------------------------
  # Create the outcome variable name dynamically
  outcome_var <- paste0("out_", str_to_lower("SS"))
  
  formula_str_player <- paste0(
    outcome_var, " ~ 1 + theta_scaled + theta_scaled:move_left + ",
    "theta_scaled:launch_speed_scaled + theta_scaled:launch_speed_scaled:move_left + ",
    "(1 + theta_scaled || fielder_id)"
  )
  
  mod_player <- glmer(
    formula = as.formula(formula_str_player),
    data = bip_gb_ss_2025,
    family = binomial(link = "probit"),
    control = glmerControl(optimizer = c("bobyqa", "Nelder_Mead"),
                           optCtrl = list(maxfun = 2e5))
  )
  
  
  # ---------------------- CALCULATING SAFE METRICS ----------------------------
  
  batted_balls <- batted_balls |>
    mutate(
      pos_angle = pos_ss$pos_angle,
      theta = abs(pos_angle - spray_angle),
      move_left = ifelse(spray_angle < pos_angle, 1, 0),
      # standardize variables based on training data
      launch_speed_scaled = (launch_speed - mean(bip_gb_ss_2025$launch_speed)) / sd(bip_gb_ss_2025$launch_speed),
      theta_scaled = (theta - mean(bip_gb_ss_2025$theta)) / sd(bip_gb_ss_2025$theta)
    )
  
  fielders <- unique(bip_gb_ss_2025$fielder_id)
  
  # Set up a data frame to store SAFE results
  safe_results <- data.frame()
  
  for (fielder_id in fielders) {
    
    bb_temp <- batted_balls
    
    bb_temp$fielder_id <- factor(fielder_id, levels = levels(bip_gb_ss_2025$fielder_id))
    
    bb_temp <- bb_temp |>
      mutate(
        prob_play_player = predict(mod_player, newdata = bb_temp, type = "response"),
        prob_play_avg = predict(mod_player, newdata = bb_temp, type = "response", re.form = NA),
        prob_play_added = prob_play_player - prob_play_avg,
        SAFE = prob_play_added * run_value * density
      ) 
    
    player_res <- bb_temp |>
      summarize(
        SAFE = sum(SAFE)
      )
    
    # append fielderid, position, SAFE, and num_plays to safe_results
    safe_results <- rbind(safe_results, data.frame(
      fielder_id = fielder_id,
      position = "SS",
      year = 2025,
      SAFE = player_res$SAFE
    ))
    
  }
```


```{r}
fit_SAFE <- function(bip_data, year, position, positioning_data, batted_balls, max_retries = 3) {
  
  # Merge position coordinates onto play data, filter to year, and compute features
  play_data <- bip_data |>
    filter(
      (successful_play == 1 & play_made_by == position) | (successful_play == 0)
    ) |>
    mutate(
      pos_x = positioning_data$pos_x,
      pos_y = positioning_data$pos_y,
      pos_angle = positioning_data$pos_angle,
      theta = abs(pos_angle - spray_angle),
      move_left = ifelse(spray_angle < pos_angle, 1, 0),
      fielder_id = case_when(
        position == "1B" ~ fielder_3,
        position == "2B" ~ fielder_4,
        position == "3B" ~ fielder_5,
        position == "SS" ~ fielder_6,
        TRUE ~ NA
      )
    ) |>
    # scaling continuous variables
    mutate(
      launch_speed_scaled = scale(launch_speed)[,1],
      theta_scaled = scale(theta)[,1]
    ) |>
    # filter out NA for all variables used in the model
    filter(
      !is.na(fielder_id),
      !is.na(launch_speed),
      !is.na(theta)
    )
  
  players_num_plays <- play_data |>
    group_by(fielder_id) |>
    summarise(num_plays = n()) |>
    arrange(num_plays) |>
    filter(num_plays >= 10) |>
    pluck("fielder_id")

  play_data <- play_data |>
    filter(fielder_id %in% players_num_plays) |>
    mutate(fielder_id = factor(fielder_id))  # Ensure it's a factor
  
  # ------------------------ FULL RANDOM EFFECTS MODEL -------------------------
  
  # Create the outcome variable name dynamically
  outcome_var <- paste0("out_", str_to_lower(position))
  
  formula_str_player <- paste0(
    outcome_var, " ~ 1 + theta_scaled + theta_scaled:move_left + ",
    "theta_scaled:launch_speed_scaled + theta_scaled:launch_speed_scaled:move_left + ",
    "(1 + theta_scaled || fielder_id)"
  )
  
  mod_player <- NULL
  attempt <- 1
  
  while(is.null(mod_player) && attempt <= max_retries) {
    
    tryCatch({
      
      if (attempt == 1) {
        # First attempt: default bobyqa
        message(paste("Fitting model for", position, year, "- Attempt", attempt))
        mod_player <- glmer(
          formula = as.formula(formula_str_player),
          data = play_data,
          family = binomial(link = "probit"),
          control = glmerControl(
            optimizer = "bobyqa",
            optCtrl = list(maxfun = 2e5)
          )
        )
        
      } else if (attempt == 2) {
        # Second attempt: Try nloptwrap optimizer
        message(paste("Retrying with nloptwrap optimizer for", position, year))
        mod_player <- glmer(
          formula = as.formula(formula_str_player),
          data = play_data,
          family = binomial(link = "probit"),
          control = glmerControl(
            optimizer = "nloptwrap",
            optCtrl = list(maxeval = 2e5)
          )
        )
        
      } else if (attempt == 3) {
        # Third attempt: Simplify random effects (intercept only)
        message(paste("Retrying with simplified random effects for", position, year))
        formula_str_simple <- paste0(
          outcome_var, " ~ 1 + theta_scaled + theta_scaled:move_left + ",
          "theta_scaled:launch_speed_scaled + theta_scaled:launch_speed_scaled:move_left + ",
          "(1 | fielder_id)"  # Only random intercept
        )
        mod_player <- glmer(
          formula = as.formula(formula_str_simple),
          data = play_data,
          family = binomial(link = "probit"),
          control = glmerControl(
            optimizer = "bobyqa",
            optCtrl = list(maxfun = 2e5)
          )
        )
      }
      
    }, error = function(e) {
      message(paste("Attempt", attempt, "failed for", position, year, ":", e$message))
      mod_player <<- NULL
    })
    
    attempt <- attempt + 1
  }
  
  # If all attempts failed, return empty results
  if (is.null(mod_player)) {
    warning(paste("All attempts failed for", position, year, "- returning empty results"))
    return(data.frame(
      fielder_id = character(),
      position = character(),
      year = numeric(),
      SAFE = numeric()
    ))
  }
  
  message(paste("Successfully fit model for", position, year))
  
  
  # ---------------------- CALCULATING SAFE METRICS ----------------------------
  
  batted_balls <- batted_balls |>
    mutate(
      pos_angle = positioning_data$pos_angle,
      theta = abs(pos_angle - spray_angle),
      move_left = ifelse(spray_angle < pos_angle, 1, 0),
      # standardize variables based on training data
      launch_speed_scaled = (launch_speed - mean(play_data$launch_speed, na.rm = TRUE)) / sd(play_data$launch_speed, na.rm = TRUE),
      theta_scaled = (theta - mean(play_data$theta, na.rm = TRUE)) / sd(play_data$theta, na.rm = TRUE),
      run_value = predict(mod_run_value, newdata = batted_balls)
    )
  
  fielders <- unique(play_data$fielder_id)
  
  # Set up a data frame to store SAFE results
  safe_results <- data.frame()
  
  for (fielder in fielders) {
    
    bb_temp <- batted_balls
    
    bb_temp$fielder_id <- factor(fielder, levels = levels(play_data$fielder_id))
    
    n_opportunities <- nrow(play_data |> filter(fielder_id == fielder))
    
    # Check that this fielder exists in the model
    if (!(fielder %in% levels(play_data$fielder_id))) {
      next
    }
    
    bb_temp <- bb_temp |>
      mutate(
        prob_play_player = predict(mod_player, newdata = bb_temp, type = "response"),
        prob_play_avg = predict(mod_player, newdata = bb_temp, type = "response", re.form = NA),
        prob_play_added = prob_play_player - prob_play_avg,
        SAFE = prob_play_added * run_value * density
      ) 
    
    player_res <- bb_temp |>
      summarize(
        SAFE = sum(SAFE, na.rm = TRUE) * n_opportunities
      )
    
    # append fielderid, position, SAFE, and num_plays to safe_results
    safe_results <- rbind(safe_results, data.frame(
      fielder_id = as.character(fielder),
      position = position,
      year = year,
      SAFE = player_res$SAFE
    ))

  }
  
  return(safe_results)
  
}
```


```{r}
#| eval: FALSE
years <- c(2023, 2024, 2025)
positions <- c("1B", "2B", "SS", "3B")

# Initialize results storage
all_safe_results <- data.frame()

for (year in years) {
  
  bip_gb_year <- bip_gb |>
    filter(game_year == year)
  
  for (position in positions) {
    
    # FIX: Filter positioning data by year AND position appropriately
    safe_pos_year <- safe_positioning |>
      filter(play_made_by == !!position)  # Adjust this filter to match your data structure
    
    safe_results <- fit_SAFE(
      bip_data = bip_gb_year,
      year = year,
      position = position,
      positioning_data = safe_pos_year,
      batted_balls = batted_balls
    )
    
    # Accumulate results
    all_safe_results <- rbind(all_safe_results, safe_results)
  }
  
}

# ------------------------- STATCAST POSITIONING DATA --------------------------

sc_positioning <- readRDS("statcast_data/player_positioning/sc_positioning.rds")




```

### Adjusting for the number of opportunities


## Results

```{r}

all_safe_results |>
  filter(year == 2023) |>
  ggplot(aes(x = SAFE, color = position)) +
  geom_density() 
```

